---
title: Authentication Setup
description: Configure Opentribe authentication with Better Auth (email & OAuth)
---

import { Callout } from "fumadocs-ui/components/callout";
import { Steps, Step } from "fumadocs-ui/components/steps";
import { Tabs, Tab } from "fumadocs-ui/components/tabs";

# Authentication Setup

Opentribe uses [Better Auth](https://better-auth.com/) to power all sign-in flows. Users authenticate with **email/password** or **social providers (Google, GitHub)**, then add their Polkadot wallet address inside their profile for payouts—wallets are not part of the login process.

## Architecture Overview

- **API Server (`apps/api`)** hosts the Better Auth instance and issues cookies.
- **Web (`apps/web`)** and **Dashboard (`apps/dashboard`)** reuse the same session cookie, so users sign in once and access both surfaces.
- **Wallet addresses** are stored as regular profile fields. Builders and org admins can update them anytime without touching authentication.

<Callout type="info">
  Because wallets are independent of authentication, you never request wallet signatures. This keeps onboarding light for non-technical contributors while still letting them receive on-chain payouts.
</Callout>

## Supported Methods

1. **Email + Password** (default Better Auth flow)
2. **Google OAuth**
3. **GitHub OAuth**

You can enable or disable any of these providers through environment variables.

## Configuration

<Steps>

<Step title="Set Shared Secrets">

Generate a long random secret and reuse it across `apps/web`, `apps/dashboard`, and `apps/api`:

```bash
openssl rand -base64 32
```

Add to every `.env.local`:

```bash
BETTER_AUTH_SECRET="your-generated-secret"
BETTER_AUTH_URL="http://localhost:3002" # API server
```

</Step>

<Step title="Configure OAuth Providers">

<Tabs>
  <Tab value="google" label="Google">
  1. Open the [Google Cloud Console](https://console.cloud.google.com) and create OAuth credentials.  
  2. Add redirect URIs:
     - `http://localhost:3002/api/auth/callback/google`
     - `https://api.opentribe.io/api/auth/callback/google`
  3. Store the credentials:
  ```bash
  GOOGLE_CLIENT_ID="xxx.apps.googleusercontent.com"
  GOOGLE_CLIENT_SECRET="GOCSPX-xxx"
  ```
  </Tab>

  <Tab value="github" label="GitHub">
  1. Go to **Settings → Developer settings → OAuth Apps**.  
  2. Set the callback URLs:
     - `http://localhost:3002/api/auth/callback/github`
     - `https://api.opentribe.io/api/auth/callback/github`
  3. Store the credentials:
  ```bash
  GITHUB_CLIENT_ID="Iv1.xxx"
  GITHUB_CLIENT_SECRET="xxx"
  ```
  </Tab>
</Tabs>

</Step>

<Step title="Enable Email Sign-In">

Email/password is enabled by default. Customize verification rules inside the Better Auth config (see next section) if you want to enforce email verification or block disposable domains.

</Step>

<Step title="Share Sessions Across Apps">

All web surfaces read the same cookie. In production, set the cookie domain to `.opentribe.io` so the session works on `opentribe.io` and `admin.opentribe.io`. Keep `secure` + `sameSite=lax` for best results.

</Step>

</Steps>

## Implementation Guide

### API Server (`apps/api`)

```typescript
import { betterAuth } from "better-auth";
import { prismaAdapter } from "better-auth/adapters/prisma";
import { db } from "@packages/db";

export const auth = betterAuth({
  database: prismaAdapter(db, { provider: "postgresql" }),

  emailAndPassword: {
    enabled: true,
    requireEmailVerification: process.env.NODE_ENV === "production",
  },

  socialProviders: {
    google: process.env.GOOGLE_CLIENT_ID
      ? {
          clientId: process.env.GOOGLE_CLIENT_ID!,
          clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
        }
      : undefined,
    github: process.env.GITHUB_CLIENT_ID
      ? {
          clientId: process.env.GITHUB_CLIENT_ID!,
          clientSecret: process.env.GITHUB_CLIENT_SECRET!,
        }
      : undefined,
  },

  session: {
    expiresIn: 60 * 60 * 24 * 30, // 30 days
    updateAge: 60 * 60 * 24, // refresh daily
  },

  cookies: {
    secure: process.env.NODE_ENV === "production",
    sameSite: "lax",
    domain:
      process.env.NODE_ENV === "production" ? ".opentribe.io" : undefined,
  },
});
```

### Client Integrations

<Tabs>
  <Tab value="react" label="React Hook">

```typescript
// packages/auth/client.ts
import { createAuthClient } from "better-auth/react";

export const authClient = createAuthClient({
  baseURL: process.env.NEXT_PUBLIC_API_URL!,
});

// usage in Next.js component
import { authClient } from "@packages/auth/client";

export function SignInButtons() {
  const session = authClient.useSession();

  if (session.data) {
    return <p>Welcome back, {session.data.user.name}</p>;
  }

  return (
    <div className="flex gap-3">
      <button onClick={() => authClient.signIn.email({ email, password })}>
        Sign in with Email
      </button>
      <button onClick={() => authClient.signIn.social({ provider: "google" })}>
        Continue with Google
      </button>
    </div>
  );
}
```

  </Tab>

  <Tab value="profile" label="Wallet Addresses">

Wallet collection happens after sign-in:

```typescript
// Example API route for updating payout wallet
import { auth } from "@packages/auth/server";
import { db } from "@packages/db";

export async function POST(request: Request) {
  const session = await auth.api.getSession({ headers: request.headers });
  if (!session) return new Response("Unauthorized", { status: 401 });

  const { walletAddress } = await request.json();
  await db.user.update({
    where: { id: session.user.id },
    data: { walletAddress },
  });

  return Response.json({ success: true });
}
```

  </Tab>
</Tabs>

## Protecting Routes

```typescript
// API route guard
import { auth } from "@packages/auth/server";

export async function GET(req: Request) {
  const session = await auth.api.getSession({ headers: req.headers });
  if (!session) return new Response("Unauthorized", { status: 401 });
  return Response.json({ message: `Hello ${session.user.name}` });
}
```

```typescript
// Next.js client guard
import { authClient } from "@packages/auth/client";
import { redirect } from "next/navigation";

export default function Dashboard() {
  const { data: session, isPending } = authClient.useSession();
  if (isPending) return <div>Loading...</div>;
  if (!session) redirect("/sign-in");
  return <div>Dashboard content</div>;
}
```

## Roles & Permissions

```typescript
enum PlatformRole {
  USER = "user",
  ADMIN = "admin",
  SUPERADMIN = "superadmin",
}

enum OrganizationRole {
  OWNER = "owner",
  ADMIN = "admin",
  MEMBER = "member",
}
```

Use these enums when checking access inside API routes or React components.

## Session Management

- Sessions live in the `Session` table (Prisma model) and refresh automatically when users stay active.
- Logout is available client-side (`authClient.signOut()`) or server-side via `auth.api.signOut`.

## Security Best Practices

1. **Secrets** – Generate strong `BETTER_AUTH_SECRET` values and rotate them periodically.
2. **HTTPS everywhere** – Force HTTPS in production and enable `secure` cookies.
3. **Rate limiting** – Protect sign-in and password reset endpoints with a limiter (e.g., `@upstash/ratelimit`).
4. **Email verification** – Enable `requireEmailVerification` for production users if impersonation is a concern.
5. **Monitoring** – Log authentication failures for anomaly detection.

## Troubleshooting

| Issue | Fix |
| --- | --- |
| Sessions not shared between apps | Confirm every app uses the same `BETTER_AUTH_SECRET` and cookie domain. |
| OAuth redirect mismatch | Ensure redirect URIs exactly match what’s in Google/GitHub configs (no trailing slashes). |
| “Invalid session” errors | Check database connection + cookie settings; clear browser cookies during debugging. |
| Wallet not saved | Remember wallet addresses are normal profile fields—verify the API route that updates profiles. |

## Next Steps

- [Configure organizations](/docs/features/organizations)
- [Collect payout wallets from builders](/docs/getting-started/for-builders)
- [Review API authentication endpoints](/docs/api/overview)
